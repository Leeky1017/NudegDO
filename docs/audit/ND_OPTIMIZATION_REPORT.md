# NudgeDO（ND）商业化优化报告（Roadmap + 工程落地）

- 编制日期：2026-01-07
- 关联审计：`docs/audit/ND_AUDIT_REPORT.md`
- Issue：#24

## 0. 目标定义：什么叫“完全可用的商业产品”

> 本节给出“工程可验收”的商业化标准，避免只做功能不做系统。

### 0.1 商业化最小门槛（建议）
- **安全**：平台级密钥不出现在前端；具备基础滥用防护与审计日志；最小权限原则
- **隐私合规**：隐私政策/同意机制/数据删除与导出；第三方处理披露；数据最小化
- **可用性**：无配置也可使用 OnMe；Nudge 有明确失败提示与降级；关键路径有测试覆盖
- **可扩展性**：前后端边界清晰；领域模型与 DTO 分层；可替换模型提供商
- **可运营**：指标（激活/留存/追问成功率/成本）可观测；支持付费与配额

## 1. 建议的目标架构（从“纯前端原型”升级）

### 1.1 总体分层（建议）
1) **Client（Web/PWA）**
   - 只负责 UI/交互/本地缓存
   - 不持有平台 Key，不直连第三方模型
2) **BFF/API（服务端）**
   - Auth/Session、LLM Proxy、配额/计费、日志/埋点、风控
3) **Data（持久化）**
   - Postgres（任务/对话/设置/订阅）
   - 可选 Redis（速率限制、短期缓存）
4) **Jobs（异步）**
   - 提醒/定时推送、统计聚合、邮件/通知

### 1.2 LLM 调用的正确落点（关键）
- 前端 → 自家 `/api/nudge/*`（携带用户 session）
- 服务端：
  - 注入供应商 Key
  - 统一 prompt 模板、重试、降级、模型路由（GLM4.5 AIR 优先）
  - 记录：请求 ID、耗时、tokens、fallback 命中、错误码（不落敏感原文或做脱敏）

### 1.3 数据模型（建议最小集）
- `users`：账号、订阅态
- `tasks`：title、状态、计划时间、notes、tags、persona、来源（OnMe/Nudge）
- `task_conversations`：message（role/content）、round、timestamps（可做脱敏存储策略）
- `settings`：maxRounds、提醒强度、粒度等
- `usage_events`：nudge 调用、token、成本、失败原因（用于配额/计费/风控）

## 2. 分阶段路线图（可执行）

### Phase 0：MVP Hardening（对外测试前，P0）
目标：解决审计中的 Critical/High，使产品在“小规模试用”下安全可控。

**交付物**
- 服务端 BFF（最小）：LLM Proxy + 基础鉴权 + 速率限制 + 日志
- 前端移除平台 Key；Nudge 失败/无 Key 降级 UI
- 对话历史持久化（至少本地持久化，Beta 可先本地，后续云端）
- 隐私政策/同意机制占位（可先工程落地，再让法务迭代文本）

**验收指标（建议）**
- 0 次平台 Key 泄露（静态搜索构建产物/源码）
- Nudge 调用成功率 ≥ 95%（失败可降级且有提示）
- 关键链路错误可追踪（有 requestId + logs）

### Phase 1：Beta（小规模付费前，P1）
目标：完成“跨端可用 + 基本运营能力 + spec 对齐”。

**交付物**
- 登录/会话（邮箱/三方登录均可）
- 云端同步（tasks/settings/conversations）
- 轮次制追问 + 设置 UI（maxRounds、粒度、提醒强度等）
- 观测与增长：埋点、漏斗、A/B（轻量）
- 工程化：lint/format、e2e smoke、错误上报

### Phase 2：Production（规模化，P2）
目标：可持续运营与成本可控。

**交付物**
- 订阅计费（免费次数/Pro、计费对账）
- 通知系统（Web Push/PWA、移动端推送或小程序）
- 数据分析（完成率、时间校准、过度承诺检测）
- 风控/滥用治理（封禁、异常检测、成本告警）
- 合规完善（数据删除 SLA、DPA、审计策略）

## 3. 任务拆解（建议直接转 GitHub Issues）

> 命名建议：`[PHASE-0] ND-P0-XXX: <title>`（后续可按仓库约定调整）

### 3.1 P0 Backlog（阻塞项优先）
| 建议 Issue | 解决的审计项 | 交付/验收要点 |
|---|---|---|
| ND-P0-001：引入服务端 LLM Proxy（BFF） | F001/F002/F003 | 前端不直连供应商；服务端注入 Key；日志/速率限制 |
| ND-P0-002：前端移除平台 Key + 无 Key 降级 UI | F001/F006 | OnMe 可用；Nudge 显示配置提示；ErrorBoundary |
| ND-P0-003：Nudge 对话历史持久化（本地） | F005 | 刷新后仍可查看；导出/导入包含对话 |
| ND-P0-004：隐私政策/同意机制工程落地 | F003/F015 | 首次使用弹窗；可撤回；文档占位 |
| ND-P0-005：修复/升级依赖漏洞策略 | F007 | 升级 Vite/相关依赖；CI 门禁策略明确 |

### 3.2 P1 Backlog（Beta 能力）
| 建议 Issue | 价值 | 交付/验收要点 |
|---|---|---|
| ND-P1-001：Auth/Session | 跨端与付费基础 | 登录后可同步 tasks/settings |
| ND-P1-002：云端同步（tasks + conversations） | 多端一致 | 冲突策略明确；离线可用 |
| ND-P1-003：轮次制追问 + 设置 UI | 对齐愿景/spec | maxRounds 生效；问答分轮；避免重复问题 |
| ND-P1-004：可观测性（Sentry/日志/指标） | 线上定位 | requestId 贯穿；失败原因统计 |
| ND-P1-005：工程化（ESLint/Prettier + e2e smoke） | 可维护 | CI 绿；格式一致 |
| ND-P1-006：Spec 对齐（更新或补齐实现） | 可审计 | 关键 spec 与默认行为一致 |

### 3.3 P2 Backlog（生产化）
| 建议 Issue | 价值 | 交付/验收要点 |
|---|---|---|
| ND-P2-001：订阅计费 + 配额系统 | 变现 | 免费次数限制、Pro 解锁、对账 |
| ND-P2-002：提醒/通知系统 | 核心体验 | 定时提醒、强度可调、失败重试 |
| ND-P2-003：“卡住了”按钮与陪伴模式 | 差异化 | 实时介入、可复用对话上下文 |
| ND-P2-004：数据分析与时间校准 | 提升完成率 | 统计+模型策略闭环 |
| ND-P2-005：风控与成本治理 | 成本可控 | 告警、限流、封禁、缓存策略 |

## 4. 策略建议（避免走弯路）

### 4.1 先“安全闭环”，再“体验堆叠”
在平台 Key 暴露与无服务端之前，任何增长/投放都会把风险与成本放大。

### 4.2 Spec 不是文档，是门禁
建议把“愿景 → spec → code”三者拉齐：短期以“更新 spec 反映现状”为主，避免 spec 继续失真。

### 4.3 LLM 成本与体验要同时治理
建议从 Phase 0 就记录 token/cost，并设计：
- 模型路由（GLM4.5 AIR 优先，必要时 fallback）
- 缓存（相同任务 prompt 的 questions 可缓存）
- 降级（模板问题、离线提示）

